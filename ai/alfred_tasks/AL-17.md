### **TASK: AL-17**

#### **Title:**
Tool Content: Implement `plan_task` Design Phase Prompts

#### **Context:**
The `plan_task` tool is now capable of handling the `Contextualize` and `Strategize` stages. We must now build out the `Design` stage. This is a critical step where the high-level strategy is broken down into a detailed, file-by-file implementation design. This task involves creating the prompt templates that will guide the AI through creating and reviewing this detailed design artifact.

#### **Implementation Details:**
1.  **Define the `DesignArtifact` model.** In `src/alfred/models/planning_artifacts.py`, define the Pydantic model for the design artifact. The core of this artifact is the `file_breakdown`, which specifies the changes for each file.
2.  **Map the artifact in the State Machine.** In `src/alfred/core/workflow.py`, add the new `DesignArtifact` model to the `artifact_map` for the `PlanTaskState.DESIGN` state.
3.  **Implement the `design.md` prompt.** Replace the `TODO` content with the full prompt. This prompt must instruct the AI to produce a JSON object matching the `DesignArtifact` model, using the previously approved strategy as its input.
4.  **Implement the `review_design.md` prompt.** This prompt will guide the AI's self-critique of the design, ensuring all key components from the strategy are accounted for.

**Files to Modify/Create:**

1.  **`src/alfred/models/planning_artifacts.py` (MODIFY):**
    ```python
    # ... imports and other models ...

    # --- DEFINE THIS NEW MODEL ---
    class FileChange(BaseModel):
        file_path: str = Field(description="The full path to the file that will be created or modified.")
        change_summary: str = Field(description="A detailed description of the new content or changes for this file.")
        operation: Literal["create", "modify"] = Field(description="Whether the file will be created or modified.")

    class DesignArtifact(BaseModel):
        design_summary: str = Field(description="A high-level summary of the implementation design.")
        file_breakdown: List[FileChange] = Field(description="A file-by-file breakdown of all required changes.")
    
    # ... other models ...
    ```

2.  **`src/alfred/core/workflow.py` (MODIFY `PlanTaskTool`):**
    ```python
    # ...
    # from src.alfred.models.planning_artifacts import ..., DesignArtifact, ...
    
    self.artifact_map = {
        # ...
        PlanTaskState.DESIGN: DesignArtifact, # <-- ADD THIS MAPPING
        # ...
    }
    # ...
    ```

3.  **`src/alfred/templates/prompts/plan_task/design.md` (REPLACE):**
    ```markdown
    # ROLE: {{ persona.name }}, {{ persona.title }}
    # ...
    # STATE: design

    The technical strategy has been approved. Now, you must translate this strategy into a detailed, file-level implementation design.

    **Approved Strategy:**
    ```json
    {{ additional_context.strategy_artifact | tojson(indent=2) }}
    ```

    ---
    ### **Directive: Create Detailed Design**

    Based on the approved strategy, create a comprehensive, file-by-file breakdown of all necessary changes. For each file that needs to be created or modified, provide a clear summary of the required changes.

    ---
    ### **Required Action**

    You MUST now call `alfred.submit_work` with a `DesignArtifact`.

    **Required Artifact Structure:**
    ```json
    {
      "design_summary": "string",
      "file_breakdown": [
        {
          "file_path": "string",
          "change_summary": "string",
          "operation": "create | modify"
        }
      ]
    }
    ```
    ```

4.  **`src/alfred/templates/prompts/plan_task/review_design.md` (REPLACE):**
    ```markdown
    # ROLE: {{ persona.name }}, {{ persona.title }}
    # ...
    # STATE: review_design

    The detailed design has been drafted. I will now perform a self-review to ensure it fully implements the approved strategy.

    ---
    ### **Directive: AI Self-Review**

    Critically evaluate the design against the original strategy.

    **Review Checklist:**
    1.  **Strategy Coverage:** Does the `file_breakdown` fully and accurately implement every `key_component` mentioned in the strategy?
    2.  **Clarity:** Is the `change_summary` for each file clear, specific, and actionable?
    3.  **Correctness:** Are the file paths and proposed operations logical and correct?

    ---
    ### **Required Action**

    If the design is sound, call `alfred.provide_review` with `is_approved=True` and a brief confirmation in `feedback_notes`.

    If the design is flawed or incomplete, call `alfred.provide_review` with `is_approved=False` and detailed `feedback_notes` on the necessary corrections.
    ```
