### **TASK: AL-18**

#### **Title:**
Tool Content: Complete `plan_task` SLOT Generation Phase

#### **Context:**
This is the final and most important stage of the `plan_task` tool. It takes the approved, detailed design and mechanically translates it into the final `ExecutionPlan` artifactâ€”our `list[SLOT]`. This task involves creating the prompt that guides this translation, including the critical instruction to generate `delegation` specs for complex SLOTs.

#### **Implementation Details:**
1.  **Define the `ExecutionPlanArtifact` type.** In `src/alfred/models/planning_artifacts.py`, this will be a simple type alias for `List[SLOT]`.
2.  **Map the artifact in the State Machine.** In `src/alfred/core/workflow.py`, map this artifact type to the `PlanTaskState.GENERATE_SLOTS` state.
3.  **Implement the `generate_slots.md` prompt.** This is the core of the task. The prompt will instruct the AI to iterate through the `file_breakdown` from the approved design and create one or more `SLOT`s for each file change. It will include explicit instructions on when to use `delegation`.
4.  **Implement the `review_plan.md` prompt.** This is the final quality gate for the entire tool. It instructs the AI to perform a holistic review of the generated `ExecutionPlan` against the original `Task`'s acceptance criteria.

**Files to Modify/Create:**

1.  **`src/alfred/models/planning_artifacts.py` (MODIFY):**
    ```python
    # ... imports ...
    from .schemas import SLOT

    # ... other artifact models ...
    
    # --- DEFINE THIS TYPE ALIAS ---
    ExecutionPlanArtifact = List[SLOT]
    ```

2.  **`src/alfred/core/workflow.py` (MODIFY `PlanTaskTool`):**
    ```python
    # ...
    # from src.alfred.models.planning_artifacts import ..., ExecutionPlanArtifact
    
    self.artifact_map = {
        # ...
        PlanTaskState.GENERATE_SLOTS: ExecutionPlanArtifact, # <-- ADD THIS MAPPING
    }
    # ...
    ```

3.  **`src/alfred/templates/prompts/plan_task/generate_slots.md` (REPLACE):**
    ```markdown
    # ROLE: {{ persona.name }}, {{ persona.title }}
    # ...
    # STATE: generate_slots

    The detailed implementation design has been approved. Your final task is to convert this design into a machine-executable `ExecutionPlan` composed of `SLOT`s.

    **Approved Design:**
    ```json
    {{ additional_context.design_artifact | tojson(indent=2) }}
    ```

    ---
    ### **Directive: Generate SLOTs**

    Mechanically translate each item in the `file_breakdown` into one or more `SLOT` objects.
    
    For each `SLOT`, you must define:
    - `slot_id`: A unique, sequential ID (e.g., "slot-1", "slot-2").
    - `title`: A concise title.
    - `spec`: A detailed specification, derived from the `change_summary`.
    - `location`: The `file_path`.
    - `operation`: The `operation`.
    - `taskflow`: A detailed `procedural_steps` and `verification_steps` (unit tests) for this specific SLOT.
    
    **CRITICAL: Use `delegation` for complex SLOTs.** If a SLOT's `spec` involves complex logic, security considerations, or significant architectural work, you MUST add a `delegation` field to it. The `delegation` spec should instruct a specialist sub-agent on how to approach the task.

    ---
    ### **Required Action**

    You MUST now call `alfred.submit_work` with the final `ExecutionPlanArtifact` (the list of `SLOT`s).

    **Required Artifact Structure:** `List[SLOT]`
    ```

4.  **`src/alfred/templates/prompts/plan_task/review_plan.md` (REPLACE):**
    ```markdown
    # ROLE: {{ persona.name }}, {{ persona.title }}
    # ...
    # STATE: review_plan

    The complete `ExecutionPlan` has been generated. I will now perform a final holistic review before presenting it for human sign-off.

    ---
    ### **Directive: Final Plan Review**

    Review the generated `list[SLOT]` against the original `Task` context.

    **Review Checklist:**
    1.  **Coverage:** Is every `acceptance_criterion` from the original task fully addressed by the combination of all SLOTs?
    2.  **Completeness:** Is the plan comprehensive? Are there any missing steps or logical gaps between SLOTs?
    3.  **Traceability:** Does the plan clearly and logically derive from the approved `strategy` and `design`?
    4.  **Delegation:** Have complex tasks been appropriately marked with a `delegation` spec?

    ---
    ### **Required Action**

    If the `ExecutionPlan` is complete and correct, call `alfred.provide_review` with `is_approved=True` to send it for final human approval.

    If the plan is flawed, call `provide_review` with `is_approved=False` and detailed `feedback_notes` explaining the required changes.